<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Learning App Creator</title>
    <style>
        :root {
            --primary: #850F8D;    /* Tmavě fialová */
            --secondary: #F8F9D7;  /* Krémová */
            --input-bg: #FFFFFF;
            --success: #4ECDC4;
            --danger: #FF6B6B;
            --dark-btn: #333;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

        body {
            margin: 0; padding: 0;
            background-color: #222;
            display: flex;
            justify-content: center;
            height: 100vh;
        }

        /* Simulace mobilu */
        #app-root {
            width: 100%;
            max-width: 400px;
            background-color: var(--primary);
            height: 100%;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* --- STYLY PRO UI --- */
        h1, h2, h3 { margin: 0; }

        .header {
            text-align: center;
            color: var(--secondary);
            padding: 20px;
            font-size: 22px;
            font-weight: bold;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .content { padding: 20px; padding-bottom: 60px; }

        /* Formuláře */
        .form-box {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .label {
            color: var(--secondary);
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }

        input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: none;
            font-size: 14px;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }

        .btn-add { background-color: var(--success); color: #000; }
        .btn-nav { background-color: var(--secondary); color: var(--primary); margin-top: 10px; }
        .btn-small { padding: 8px; font-size: 12px; }
        .btn-edit { background-color: #ffc107; color: #000; width: auto; margin-left: 5px; }
        .btn-delete { background-color: var(--danger); color: #000; width: auto; margin-left: 5px; }

        /* Karty Lekcí */
        .card {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            position: relative;
        }
        .card:hover { transform: translateY(-2px); }
        
        .card-title { color: var(--primary); font-size: 18px; font-weight: bold; }
        .card-desc { color: #555; font-size: 14px; margin-top: 5px; }
        .card-hint { font-size: 11px; text-align: right; color: var(--primary); font-style: italic; margin-top: 10px;}

        /* Detail Sekce */
        .nav-bar {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            backdrop-filter: blur(5px);
            z-index: 10;
        }
        .back-btn {
            background: none; color: var(--secondary); width: auto; padding: 0; margin-right: 15px; font-size: 16px;
        }
        .nav-title { color: var(--secondary); font-weight: bold; font-size: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .section-container {
            background: rgba(248, 249, 215, 0.05);
            border: 1px solid rgba(248, 249, 215, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .section-header {
            text-align: center; margin-bottom: 15px;
        }
        .section-badge {
            background: rgba(0,0,0,0.3);
            color: var(--secondary);
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: bold;
            display: inline-block;
        }

        /* Seznam lekcí */
        .exercise-item {
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 30px;
            margin-bottom: 8px;
        }
        .ex-circle {
             height: 36px;
            background: var(--secondary);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            font-size: 14px;
        }
        .ex-id { color: #ddd; font-family: monospace; font-size: 12px; }

        /* Export tlačítko */
        .divider { height: 1px; background: rgba(255,255,255,0.2); margin: 30px 0; }
        .btn-export {
            background: #333; color: #fff; font-family: monospace; border: 1px solid #555;
        }

        /* Row pro inputy */
        .row { display: flex; gap: 10px; }
    </style>
</head>
<body>

<div id="app-root">
    </div>

    <script>
        // --- STAV APLIKACE ---
        const INVESTIGO_BASE_URL = 'https://lesson-form.onrender.com';
        let learningData = [];
        let activeLessonId = null; 
        let isLoading = false;
    
        // --- LOGIKA (Funkce pro přidání, úpravy, mazání jsou ponechány beze změny) ---
    
        async function addSuperLesson() {
            const titleInput = document.getElementById('sl-title');
            const descInput = document.getElementById('sl-desc');
            if(!titleInput.value.trim()) { alert('Vyplňte název!'); return; }
            try {
                await fetch('/api/super-lessons', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: titleInput.value, description: descInput.value }) });
                titleInput.value = ''; descInput.value = ''; await loadFromServer(true);
            } catch (err) { console.error(err); alert('Nepodařilo se vytvořit super lekci.'); }
        }
    
        async function editSuperLesson(lessonId) {
            const lesson = learningData.find(l => String(l.id) === String(lessonId));
            if (!lesson) return;
            const newTitle = prompt('Uprav název super lekce:', lesson.title);
            if (newTitle === null) return;
            const newDesc = prompt('Uprav popis (může být prázdný):', lesson.description || '');
            try {
                await fetch(`/api/super-lessons/${lessonId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: newTitle.trim(), description: newDesc }) });
                await loadFromServer(true);
            } catch (err) { console.error(err); alert('Nepodařilo se uložit změny super lekce.'); }
        }
    
        async function deleteSuperLesson(lessonId) {
            const lesson = learningData.find(l => String(l.id) === String(lessonId));
            if (!lesson) return;
            if (!confirm(`Opravdu smazat super lekci "${lesson.title}" včetně všech oddělení a lekcí?`)) return;
            try {
                await fetch(`/api/super-lessons/${lessonId}`, { method: 'DELETE' });
                if (activeLessonId === lessonId) { activeLessonId = null; }
                await loadFromServer(true);
            } catch (err) { console.error(err); alert('Mazání super lekce selhalo.'); }
        }
    
        async function addSection() {
            const titleInput = document.getElementById('sec-title');
            if(!titleInput.value.trim()) { alert('Vyplňte název oddělení!'); return; }
            const lesson = learningData.find(l => String(l.id) === String(activeLessonId));
            if (!lesson) return;
            try {
                await fetch('/api/sections', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ lessonId: lesson.id, title: titleInput.value }) });
                titleInput.value = ''; await loadFromServer(true);
            } catch (err) { console.error(err); alert('Nepodařilo se přidat oddělení.'); }
        }
    
        async function editSection(sectionId) {
            const lesson = learningData.find(l => String(l.id) === String(activeLessonId));
            if (!lesson) return;
            const section = lesson.sections.find(s => String(s.id) === String(sectionId));
            if (!section) return;
            const newTitle = prompt('Uprav název oddělení:', section.title);
            if (newTitle === null) return;
            const trimmedTitle = newTitle.trim();
            if (!trimmedTitle) return;
            try {
                await fetch(`/api/sections/${sectionId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: trimmedTitle }) });
                await loadFromServer(true);
            } catch (err) { console.error(err); alert('Nepodařilo se upravit oddělení.'); }
        }
    
        async function deleteSection(sectionId) {
            const lesson = learningData.find(l => String(l.id) === String(activeLessonId));
            if (!lesson) return;
            const section = lesson.sections.find(s => String(s.id) === String(sectionId));
            if (!section) return;
            if (!confirm(`Opravdu smazat oddělení "${section.title}" včetně všech lekcí?`)) return;
            try {
                await fetch(`/api/sections/${sectionId}`, { method: 'DELETE' });
                await loadFromServer(true);
            } catch (err) { console.error(err); alert('Mazání oddělení selhalo.'); }
        }
    
        function addExercise(sectionId) {
            const url = `${INVESTIGO_BASE_URL}/?sectionId=${encodeURIComponent(sectionId)}`;
            const newWindow = window.open(url, '_blank');
            if (!newWindow) { alert('Pop-up blokován! Povolte pop-up okna pro tento web a zkuste to znovu.'); }
        }
    
   // NAHRADÍ TUTO FUNKCI:
function editExercise(sectionId, lessonId) {
    const lesson = learningData.find(l => l.id === activeLessonId);
    if (!lesson) return;
    const section = lesson.sections.find(s => String(s.id) === String(sectionId));
    if (!section) return;
    const currentLesson = section.exercises.find(e => String(e.id) === String(lessonId));
    if (!currentLesson) return;

    // Původní data Lekce
    const oldData = currentLesson.lesson_all_data;

    // Vyzveme k úpravě všech polí
    const newTitle = prompt('Uprav název lekce:', oldData.title);
    if (newTitle === null) return;
    
    const newIntro = prompt('Uprav INTRO:', oldData.intro || '');
    if (newIntro === null) return;

    const newBeforeExercise = prompt('Uprav BEFORE_EXERCISE:', oldData.before_exercise || '');
    if (newBeforeExercise === null) return;

    const newOutro = prompt('Uprav OUTRO:', oldData.outro || '');
    if (newOutro === null) return;

    // Data k odeslání
    const updateData = {
        title: newTitle.trim(),
        intro: newIntro,
        before_exercise: newBeforeExercise,
        outro: newOutro
    };

    // Odeslání PATCH požadavku na server
    fetch(`/api/lessons/${lessonId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updateData)
    })
    .then(res => {
        if (!res.ok) throw new Error('Úprava selhala na serveru.');
        return res.json();
    })
    .then(() => {
        alert("Lekce byla úspěšně upravena na serveru.");
        loadFromServer(true); // Znovu načteme data pro aktualizaci zobrazení
    })
    .catch(err => {
        console.error(err);
        alert('Chyba při úpravě lekce: ' + err.message);
    });
}
    
        // NAHRADÍ TUTO FUNKCI:
function deleteExercise(sectionId, lessonId) {
    const lesson = learningData.find(l => String(l.id) === String(activeLessonId));
    if (!lesson) return;
    const section = lesson.sections.find(s => String(s.id) === String(sectionId));
    if (!section) return;
    const currentLesson = section.exercises.find(e => String(e.id) === String(lessonId));
    if (!currentLesson) return;
    
    if (!confirm(`Opravdu smazat lekci "${currentLesson.label}" (ID: ${currentLesson.id})? Tímto se smažou i všechna přidružená cvičení!`)) return;
    
    // Odeslání DELETE požadavku na server
    fetch(`/api/lessons/${lessonId}`, {
        method: 'DELETE'
    })
    .then(res => {
        if (!res.ok) throw new Error('Mazání selhalo na serveru.');
        alert("Lekce byla úspěšně smazána na serveru.");
        loadFromServer(true); // Znovu načteme data pro aktualizaci zobrazení
    })
    .catch(err => {
        console.error(err);
        alert('Chyba při mazání lekce: ' + err.message);
    });
}
    
        function exportData() {
            console.clear();
            console.log("--- VAŠE DATA (JSON) ---");
            console.log(JSON.stringify(learningData, null, 2));
            console.log("------------------------");
            alert("Data byla vypsána do konzole prohlížeče (Stiskni F12 -> Console)");
        }
    
        async function loadFromServer(keepActive = false) {
            if (isLoading) return;
            isLoading = true;
            try {
                const res = await fetch('/api/data');
                if (!res.ok) throw new Error('Chyba při načítání dat ze serveru');
                const data = await res.json();
                
                learningData = (Array.isArray(data) ? data : []).map(l => ({
                    ...l,
                    id: String(l.id),
                    sections: (l.sections || []).map(s => ({
                        ...s,
                        id: String(s.id),
                        exercises: (s.exercises || []).map(e => ({
                            ...e,
                            id: String(e.id), 
                            label: e.label || '??' 
                        }))
                    }))
                }));
    
                if (keepActive && activeLessonId) {
                    const stillExists = learningData.some(l => l.id === activeLessonId);
                    if (!stillExists) activeLessonId = null;
                } else {
                    activeLessonId = null;
                }
            } catch (err) {
                console.error(err);
                alert('Nepodařilo se načíst data ze serveru.');
            } finally {
                isLoading = false;
                renderApp();
            }
        }
    
        // --- RENDER ---
    
        function renderApp() {
            const root = document.getElementById('app-root');
            
            if (activeLessonId === null) {
                // ... vykreslení hlavní stránky (SuperLekce)
                 let html = `<div class="header">Admin: Strom Učení</div><div class="content"><div class="form-box"><span class="label">Nová Super Lekce:</span><input type="text" id="sl-title" placeholder="Název (např. Základy)"><input type="text" id="sl-desc" placeholder="Popis"><button class="btn-add" onclick="addSuperLesson()">+ PŘIDAT SUPER LEKCI</button></div><div class="divider"></div>`;
                learningData.forEach(lesson => {
                    html += `<div class="card" onclick="activeLessonId = '${lesson.id}'; renderApp()"><div class="card-title">${lesson.title}</div><div class="card-desc">${lesson.description || ''}</div><div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;"><div class="card-hint">Klikni pro otevření →</div><div><button class="btn-edit btn-small" onclick="event.stopPropagation(); editSuperLesson('${lesson.id}')">Upravit</button><button class="btn-delete btn-small" onclick="event.stopPropagation(); deleteSuperLesson('${lesson.id}')">Smazat</button></div></div></div>`;
                });
                html += `<div class="divider"></div><button class="btn-export" onclick="exportData()">EXPORT DATA DO KONZOLE (DEBUG)</button><button class="btn-nav" onclick="loadFromServer(true)">ZNOVU NAČÍST ZE SERVERU</button></div>`;
                root.innerHTML = html;
    
            } else {
                // ---> ZOBRAZIT DETAIL LEKCE (SEKCE)
                const lesson = learningData.find(l => String(l.id) === String(activeLessonId));
                if (!lesson) { activeLessonId = null; renderApp(); return; }
                let html = `<div class="nav-bar"><button class="back-btn" onclick="activeLessonId = null; renderApp()">← ZPĚT</button><div class="nav-title">${lesson.title}</div></div><div class="content"><div class="form-box"><span class="label">Přidat Oddělení (Sekci):</span><input type="text" id="sec-title" placeholder="Název (např. Zvířata)"><button class="btn-add" onclick="addSection()">+ PŘIDAT ODDĚLENÍ</button></div>`;
    
                lesson.sections.forEach(section => {
                    html += `
                        <div class="section-container">
                            <div class="section-header">
                                <span class="section-badge">${section.title}</span>
                                <div style="margin-top:8px;">
                                    <button class="btn-edit btn-small" onclick="editSection('${section.id}')">Upravit oddělení</button>
                                    <button class="btn-delete btn-small" onclick="deleteSection('${section.id}')">Smazat oddělení</button>
                                </div>
                            </div>
    
                            <div id="list-${section.id}">
                    `;
    
                    // ITERACE PŘES LESSONS (které se jmenují exercises v JS)
                    section.exercises.forEach(lessonItem => {
                        const lessonData = lessonItem.lesson_all_data;
                        
                        // START VYPISU VŠECH DAT LEKCE
                        html += `
                            <div class="exercise-item" style="display:block; padding: 12px; background: rgba(255, 255, 255, 0.1);">
                                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 8px;">
                                    <div class="ex-circle">${lessonItem.label}</div>
                                    <div style="flex:1;"><div class="ex-id">ID Lekce: ${lessonItem.id}</div></div>
                                    <div>
                                        <button class="btn-edit btn-small" onclick="editExercise('${section.id}', '${lessonItem.id}')">✎</button>
                                        <button class="btn-delete btn-small" onclick="deleteExercise('${section.id}', '${lessonItem.id}')">✕</button>
                                    </div>
                                </div>
                                
                                <hr style="border: none; border-top: 1px dashed rgba(255,255,255,0.3); margin: 5px 0 10px 0;">
    
                                <div style="color: var(--secondary); font-size: 13px; line-height: 1.5;">
                                    <strong>INTRO:</strong> ${lessonData.intro || '—'}<br>
                                    <strong>BEFORE EX:</strong> ${lessonData.before_exercise || '—'}<br>
                                    <strong>OUTRO:</strong> ${lessonData.outro || '—'}<br>
                                    <span style="font-size: 10px; color: #ccc;">Vytvořeno: ${new Date(lessonData.created_at).toLocaleString()}</span>
                                </div>
    
                                <h4 style="color: #ffc107; font-size: 14px; margin-top: 15px; margin-bottom: 5px;">Cvičení (Exercises): ${lessonItem.exercises.length}</h4>
                        `;
                        // END VYPISU VŠECH DAT LEKCE
    
                        // START VYPISU VŠECH DAT CVIČENÍ
                        // Opravený kód pro vypisování dat Cvičení
// NAHRADIT TENTO CYKLUS UVNITŘ lessonItem.exercises.forEach:
// START VYPISU VŠECH DAT CVIČENÍ
lessonItem.exercises.forEach((ex, index) => {
    const exData = ex.exercise_all_data;
    
    // Zjistíme, jestli data existují. (Převzato z předchozí opravy)
    let dataContent = exData.data_content;
    let displayContent = 'PRÁZDNÉ';
    let dataColor = 'var(--danger)';

    if (dataContent) {
        let contentString;
        if (typeof dataContent === 'object' && dataContent !== null) {
            contentString = JSON.stringify(dataContent);
        } else {
            contentString = String(dataContent);
        }

        dataColor = 'var(--success)';
        // Váš kód, který ukazuje celý obsah:
        displayContent = contentString; 
    }

    html += `
        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-bottom: 5px; font-size: 12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight: bold; color: #ffc107;">EX ID: ${ex.id}</div>
                <div>
                    <button class="btn-edit btn-small" onclick="editIndividualExercise('${ex.id}')" style="margin-right: 5px;">✎</button>
                    <button class="btn-delete btn-small" onclick="deleteIndividualExercise('${ex.id}')">✕</button>
                </div>
            </div>
            
            <strong>Typ:</strong> ${exData.type}<br>
            <strong>Otázka:</strong> ${exData.question}<br>
            <strong>Obsah (DATA):</strong> <span style="font-family: monospace; color: ${dataColor};">${displayContent}</span><br>
            <span style="font-size: 10px; color: #ccc;">Vytvořeno: ${new Date(exData.created_at).toLocaleString()}</span>
        </div>
    `;
});
// END VYPISU VŠECH DAT CVIČENÍ
                        // END VYPISU VŠECH DAT CVIČENÍ
    
                        html += `</div>`; // Uzavření exercise-item
                    });
    
                    html += `
                            </div>
                            
                            <div style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top:10px;">
                                <span class="label" style="font-size:11px; color:#aaa;">Novou lekci vytvoř v aplikaci Investigo:</span>
                                <button class="btn-nav btn-small" onclick="addExercise('${section.id}')">+ Přidat lekci v Investigo</button>
                            </div>
                        </div>
                    `;
                });
    
                html += '</div>';
                root.innerHTML = html;
            }
        }
    
        // První spuštění – načti data ze serveru (pokud běží)
        window.addEventListener('load', loadFromServer);
    
    </script>

</body>
</html>